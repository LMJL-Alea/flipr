<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>On the exactness of permutation tests • flipr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="On the exactness of permutation tests">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">flipr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3.3.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/flipr.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/alternative.html">The alternative hypothesis in permutation testing</a>
    </li>
    <li>
      <a href="../articles/exactness.html">On the exactness of permutation tests</a>
    </li>
    <li>
      <a href="../articles/plausibility.html">Computing plausibility functions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/LMJL-Alea/flipr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>On the exactness of permutation tests</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/LMJL-Alea/flipr/blob/master/vignettes/exactness.Rmd" class="external-link"><code>vignettes/exactness.Rmd</code></a></small>
      <div class="hidden name"><code>exactness.Rmd</code></div>

    </div>

    
    
<p>In this article, we discuss the exactness property of permutation
tests, which is closely related to how
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>-values
are computed from the permutations. This article is a summary of the
paper by <span class="citation">Phipson and Smyth (2010)</span>.</p>
<div class="section level2">
<h2 id="traditional-formulation-of-a-statistical-test">Traditional formulation of a statistical test<a class="anchor" aria-label="anchor" href="#traditional-formulation-of-a-statistical-test"></a>
</h2>
<p>A statistical test aims at determining whether some observed data can
be considered to be strong evidence in favor of a so-called
<em>alternative</em> hypothesis
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>H</mi><mi>a</mi></msub><annotation encoding="application/x-tex">H_a</annotation></semantics></math>
compared to a so-called <em>null</em> hypothesis
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>H</mi><mn>0</mn></msub><annotation encoding="application/x-tex">H_0</annotation></semantics></math>.
To do that, a test statistic
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>
is defined such that:</p>
<ul>
<li>its observed value under
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>H</mi><mn>0</mn></msub><annotation encoding="application/x-tex">H_0</annotation></semantics></math>
can be computed once you observed some data;</li>
<li>large values of the statistic are evidence in favor of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>H</mi><mi>a</mi></msub><annotation encoding="application/x-tex">H_a</annotation></semantics></math>.</li>
<li>you know (an approximation of) the distribution of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>
under the null hypothesis, also known as the <strong>null
distribution</strong>.</li>
</ul>
<p>Once such a test statistic is available and we observe some data, we
can denote by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">s</mi></mrow></msub><annotation encoding="application/x-tex">t_\mathrm{obs}</annotation></semantics></math>
the value of the test statistic computed from the observed data and
define the so-called <strong>p-value</strong> as the null hypothesis
tail probability:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>∞</mi></msub><mo>=</mo><msub><mi>ℙ</mi><msub><mi>H</mi><mn>0</mn></msub></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>T</mi><mo>≥</mo><msub><mi>t</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">s</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex"> p_\infty = \mathbb{P}_{H_0} \left( T \ge t_\mathrm{obs} \right). </annotation></semantics></math>The
p-value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>∞</mi></msub><annotation encoding="application/x-tex">p_\infty</annotation></semantics></math>
is by definition uniformly distributed on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(0,1)</annotation></semantics></math>
under the null hypothesis. Hence, we can define the so-called
<strong>significance level</strong>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>∈</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\alpha \in (0,1)</annotation></semantics></math>
and decide to reject
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>H</mi><mn>0</mn></msub><annotation encoding="application/x-tex">H_0</annotation></semantics></math>
in favor of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>H</mi><mn>1</mn></msub><annotation encoding="application/x-tex">H_1</annotation></semantics></math>
when
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>∞</mi></msub><mo>≤</mo><mi>α</mi></mrow><annotation encoding="application/x-tex">p_\infty \le \alpha</annotation></semantics></math>.
By doing this, the probability of wrongly rejecting
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>H</mi><mn>0</mn></msub><annotation encoding="application/x-tex">H_0</annotation></semantics></math>,
also known as the probability of type I errors, is simply:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ℙ</mi><msub><mi>H</mi><mn>0</mn></msub></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>p</mi><mi>∞</mi></msub><mo>≤</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>α</mi><mi>.</mi></mrow><annotation encoding="application/x-tex"> \mathbb{P}_{H_0} \left( p_\infty \le \alpha \right) = \alpha. </annotation></semantics></math>The
significance level
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
therefore matches by design the probability of type I errors, which
means that choosing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
allows to control the probability of type I errors. We say that the test
is <strong>exact</strong>.</p>
<p>When the null distribution of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>
is not known, you do not have access to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>∞</mi></msub><annotation encoding="application/x-tex">p_\infty</annotation></semantics></math>.
A possible solution is then to resort to resampling techniques to
approach the null hypothesis. Once you get an approximate null
distribution, the question is how do you compute a p-value that provides
an exact statistical test. There are two approaches to this problem: the
first estimates the true p-value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>∞</mi></msub><annotation encoding="application/x-tex">p_\infty</annotation></semantics></math>
from the approximate null distribution while the second proposes an
alternative definition of the p-value that can be straightforwardly
computed. Let us expand on both approaches.</p>
</div>
<div class="section level2">
<h2 id="the-two-sample-problem-in-a-permutational-framework">The two-sample problem in a permutational framework<a class="anchor" aria-label="anchor" href="#the-two-sample-problem-in-a-permutational-framework"></a>
</h2>
<p>We start with two samples
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mn>1</mn></msub><mo>,</mo><mi>…</mi><mo>,</mo><msub><mi>X</mi><msub><mi>n</mi><mi>x</mi></msub></msub><mover><mo>∼</mo><mrow><mi>i</mi><mi>i</mi><mi>d</mi></mrow></mover><mi>𝒟</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>θ</mi><mi>x</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">X_1, \dots, X_{n_x} \stackrel{iid}{\sim} \mathcal{D}(\theta_x)</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mn>1</mn></msub><mo>,</mo><mi>…</mi><mo>,</mo><msub><mi>Y</mi><msub><mi>n</mi><mi>y</mi></msub></msub><mover><mo>∼</mo><mrow><mi>i</mi><mi>i</mi><mi>d</mi></mrow></mover><mi>𝒟</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>θ</mi><mi>y</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y_1, \dots, Y_{n_y} \stackrel{iid}{\sim} \mathcal{D}(\theta_y)</annotation></semantics></math>.
We want to know whether the two distributions are the same or not on the
basis of the two samples we collected. In this parametric setting, it
boils down to testing the following hypotheses:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mn>0</mn></msub><mo>:</mo><msub><mi>θ</mi><mi>x</mi></msub><mo>=</mo><msub><mi>θ</mi><mi>y</mi></msub><mspace width="1.0em"></mspace><mtext mathvariant="normal">vs</mtext><mspace width="1.0em"></mspace><msub><mi>θ</mi><mi>x</mi></msub><mo>≠</mo><msub><mi>θ</mi><mi>y</mi></msub><mi>.</mi></mrow><annotation encoding="application/x-tex"> H_0: \theta_x = \theta_y \quad \mbox{vs} \quad \theta_x \neq \theta_y. </annotation></semantics></math>Let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>
be a statistic that depends on the two samples which is suited for
elucidating this test, i.e.:</p>
<ul>
<li>you can compute its observed value under the null hypothesis once
you observed some data;</li>
<li>large values of the statistic are evidence in favor of the
alternative hypothesis.</li>
</ul>
<p>Now, for performing the test, one should also know (an approximation
of) the distribution of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>
under the null hypothesis, also known as the <strong>null
distribution</strong>, from which the p-value associated to this test
can be computed for instance.</p>
<p>If one knows the exact null distribution, then there is no need to
resort to permutations. However, if the null distribution is not known,
permutations come in handy for approaching it.</p>
<p>The idea is that, under the null hypothesis, the two samples come
from the same distribution. Hence, we can pull them together as one big
sample of size
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><msub><mi>n</mi><mi>x</mi></msub><mo>+</mo><msub><mi>n</mi><mi>y</mi></msub></mrow><annotation encoding="application/x-tex">n = n_x + n_y</annotation></semantics></math>
generated by that common distribution. At this point, we can split the
pooled sample into two random subsets of size
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>n</mi><mi>x</mi></msub><annotation encoding="application/x-tex">n_x</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>n</mi><mi>y</mi></msub><annotation encoding="application/x-tex">n_y</annotation></semantics></math>
respectively, and use them to compute a value of the statistic
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>.
If we repeat many times this splitting strategy, say
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>m</mi><annotation encoding="application/x-tex">m</annotation></semantics></math>
times, we end up with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>m</mi><annotation encoding="application/x-tex">m</annotation></semantics></math>
values of the statistic from which we can compute the empirical
distribution, known as the <strong>permutation distribution</strong>,
which approaches the null distribution.</p>
</div>
<div class="section level2">
<h2 id="permutation-p-value-as-an-unbiased-estimator-of-p_infty">Permutation p-value as an unbiased estimator of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>∞</mi></msub><annotation encoding="application/x-tex">p_\infty</annotation></semantics></math><a class="anchor" aria-label="anchor" href="#permutation-p-value-as-an-unbiased-estimator-of-p_infty"></a>
</h2>
<p>Let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">s</mi></mrow></msub><annotation encoding="application/x-tex">t_\mathrm{obs}</annotation></semantics></math>
be the value of the statistic computed from the original two samples,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>m</mi><annotation encoding="application/x-tex">m</annotation></semantics></math>
be the number of permutations used to approach the null distribution and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>
be a random variable that counts the number of test statistic values
greater than or equal to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">s</mi></mrow></msub><annotation encoding="application/x-tex">t_\mathrm{obs}</annotation></semantics></math>.</p>
<p>By definition, the random variable
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>
follows a binomial distribution of size
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>m</mi><annotation encoding="application/x-tex">m</annotation></semantics></math>
and rate of success
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>∞</mi></msub><annotation encoding="application/x-tex">p_\infty</annotation></semantics></math>.
Hence, we can define the following <strong>unbiased estimator</strong>
of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>∞</mi></msub><annotation encoding="application/x-tex">p_\infty</annotation></semantics></math>:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><msub><mi>p</mi><mi>∞</mi></msub><mo accent="true">̂</mo></mover><mo>=</mo><mfrac><mi>B</mi><mi>m</mi></mfrac><mi>.</mi></mrow><annotation encoding="application/x-tex"> \widehat{p_\infty} = \frac{B}{m}. </annotation></semantics></math></p>
<p>However, when one uses this estimator of the p-value for the purpose
of hypothesis testing, the resulting test is not exact. Let us
investigate why.</p>
<p>First, remember that the true p-value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>∞</mi></msub><annotation encoding="application/x-tex">p_\infty</annotation></semantics></math>
is a random variable itself, in the sense that its value changes as soon
as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">s</mi></mrow></msub><annotation encoding="application/x-tex">t_\mathrm{obs}</annotation></semantics></math>
changes i.e. each time the whole experiment is reconducted. Hence, the
probability of wrongly rejecting the null hypothesis using
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><msub><mi>p</mi><mi>∞</mi></msub><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\widehat{p_\infty}</annotation></semantics></math>
reads:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ℙ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mover><msub><mi>p</mi><mi>∞</mi></msub><mo accent="true">̂</mo></mover><mo>≤</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mo>∫</mo><mi>ℝ</mi></msub><mi>ℙ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mover><msub><mi>p</mi><mi>∞</mi></msub><mo accent="true">̂</mo></mover><mo>≤</mo><mi>α</mi><mo stretchy="false" form="prefix">|</mo><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>f</mi><msub><mi>p</mi><mi>∞</mi></msub></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><mi>p</mi><mo>=</mo><msubsup><mo>∫</mo><mn>0</mn><mn>1</mn></msubsup><mi>ℙ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mover><msub><mi>p</mi><mi>∞</mi></msub><mo accent="true">̂</mo></mover><mo>≤</mo><mi>α</mi><mo stretchy="false" form="prefix">|</mo><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><mi>p</mi><mo>,</mo></mrow><annotation encoding="application/x-tex"> \mathbb{P} \left( \widehat{p_\infty} \le \alpha \right) = \int_\mathbb{R} \mathbb{P} \left( \widehat{p_\infty} \le \alpha | p \right) f_{p_\infty}(p) dp = \int_0^1 \mathbb{P} \left( \widehat{p_\infty} \le \alpha | p \right) dp, </annotation></semantics></math>because
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>∞</mi></msub><annotation encoding="application/x-tex">p_\infty</annotation></semantics></math>
is uniformly distributed on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(0,1)</annotation></semantics></math>
under the null hypothesis.</p>
<p>Next, notice that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><msub><mi>p</mi><mi>∞</mi></msub><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\widehat{p_\infty}</annotation></semantics></math>
can only take on a finite set of values
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">{</mo><mn>0</mn><mo>,</mo><mfrac><mn>1</mn><mi>m</mi></mfrac><mo>,</mo><mfrac><mn>2</mn><mi>m</mi></mfrac><mo>,</mo><mi>…</mi><mo>,</mo><mfrac><mrow><mi>m</mi><mo>−</mo><mn>1</mn></mrow><mi>m</mi></mfrac><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\left\{ 0, \frac{1}{m}, \frac{2}{m}, \dots, \frac{m-1}{m}, 1 \right\}</annotation></semantics></math>.
Hence, we have for any
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>∈</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">b \in 0, 1, \dots, m</annotation></semantics></math>:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ℙ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mover><msub><mi>p</mi><mi>∞</mi></msub><mo accent="true">̂</mo></mover><mo>=</mo><mfrac><mi>b</mi><mi>m</mi></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msubsup><mo>∫</mo><mn>0</mn><mn>1</mn></msubsup><mi>ℙ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mover><msub><mi>p</mi><mi>∞</mi></msub><mo accent="true">̂</mo></mover><mo>=</mo><mrow><mfrac><mi>b</mi><mi>m</mi></mfrac><mo stretchy="true" form="postfix">|</mo></mrow><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><mi>p</mi><mo>=</mo><msubsup><mo>∫</mo><mn>0</mn><mn>1</mn></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mfrac linethickness="0"><mi>m</mi><mi>b</mi></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>p</mi><mi>b</mi></msup><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>m</mi><mo>−</mo><mi>b</mi></mrow></msup><mi>d</mi><mi>p</mi><mo>=</mo><mfrac><mn>1</mn><mrow><mi>m</mi><mo>+</mo><mn>1</mn></mrow></mfrac><mi>.</mi></mrow><annotation encoding="application/x-tex"> \mathbb{P} \left( \widehat{p_\infty} = \frac{b}{m} \right) = \int_0^1 \mathbb{P} \left( \widehat{p_\infty} = \left. \frac{b}{m} \right| p \right) dp = \int_0^1 \binom{m}{b} p^b (1-p)^{m-b} dp = \frac{1}{m + 1}. </annotation></semantics></math></p>
<p>We can therefore deduce that:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ℙ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mover><msub><mi>p</mi><mi>∞</mi></msub><mo accent="true">̂</mo></mover><mo>≤</mo><mi>α</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><mo stretchy="false" form="prefix">⌊</mo><mi>m</mi><mi>α</mi><mo stretchy="false" form="postfix">⌋</mo><mo>+</mo><mn>1</mn></mrow><mrow><mi>m</mi><mo>+</mo><mn>1</mn></mrow></mfrac><mo>≠</mo><mi>α</mi><mi>.</mi></mrow><annotation encoding="application/x-tex"> \mathbb{P} \left( \widehat{p_\infty} \le \alpha \right) = \frac{\lfloor m \alpha \rfloor + 1}{m + 1} \neq \alpha. </annotation></semantics></math></p>
<p>The following R code shows graphically that using
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><msub><mi>p</mi><mi>∞</mi></msub><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\widehat{p_\infty}</annotation></semantics></math>
as p-value does not provide an exact test:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.1</span>, by <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">100</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">crossing</span><span class="op">(</span><span class="va">alpha</span>, <span class="va">m</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    p <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">m</span> <span class="op">*</span> <span class="va">alpha</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">m</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>    mf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"m ="</span>, <span class="va">m</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">alpha</span>, <span class="va">p</span>, color <span class="op">=</span> <span class="va">mf</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_abline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Significance level"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Probability of wrongly rejecting H0"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">mf</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_color_viridis_d</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">fig</span> <span class="op">&lt;-</span> <span class="va">p1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">plotly</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plotly/man/ggplotly.html" class="external-link">ggplotly</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">plotly</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plotly/man/hide_legend.html" class="external-link">hide_legend</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">htmlwidgets</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/htmlwidgets/man/saveWidget.html" class="external-link">saveWidget</a></span><span class="op">(</span></span>
<span>  widget <span class="op">=</span> <span class="va">fig</span>, </span>
<span>  file <span class="op">=</span> <span class="st">"exactness-fig1.html"</span>, </span>
<span>  selfcontained <span class="op">=</span> <span class="fu">rmarkdown</span><span class="fu">::</span><span class="fu"><a href="https://pkgs.rstudio.com/rmarkdown/reference/pandoc_available.html" class="external-link">pandoc_available</a></span><span class="op">(</span><span class="st">"1.12.3"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">htmltools</span><span class="fu">::</span><span class="va"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">tags</a></span><span class="op">$</span><span class="fu">iframe</span><span class="op">(</span></span>
<span>  src <span class="op">=</span> <span class="st">"exactness-fig1.html"</span>,</span>
<span>  scrolling <span class="op">=</span> <span class="st">"no"</span>, </span>
<span>  seamless <span class="op">=</span> <span class="st">"seamless"</span>,</span>
<span>  frameBorder <span class="op">=</span> <span class="st">"0"</span>,</span>
<span>  width <span class="op">=</span> <span class="st">"100%"</span>, </span>
<span>  height <span class="op">=</span> <span class="fl">400</span></span>
<span><span class="op">)</span></span></code></pre></div>
<iframe src="exactness-fig1.html" scrolling="no" seamless="seamless" frameborder="0" width="100%" height="400"></iframe>
</div>
<div class="section level2">
<h2 id="permutation-p-value-as-the-tail-probability-of-a-resampling-distribution">Permutation p-value as the tail probability of a resampling
distribution<a class="anchor" aria-label="anchor" href="#permutation-p-value-as-the-tail-probability-of-a-resampling-distribution"></a>
</h2>
<p>An alternative strategy is to define the p-value by looking at the
random variable
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>
instead of the test statistic
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>.
While the p-value is the tail probability of the null distribution, in
the context of randomization tests, we can define it as the tail
probability of the distribution of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>.
Given a fixed number
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>m</mi><annotation encoding="application/x-tex">m</annotation></semantics></math>
of sampled permutations, recall that the random variable
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>
counts the number of test statistic values larger than or equal to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">s</mi></mrow></msub><annotation encoding="application/x-tex">t_\mathrm{obs}</annotation></semantics></math>.
Hence, an alternative equivalent definition of the p-value is given by
the so-called <strong>exact permutation p-value</strong>:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>e</mi></msub><mo>=</mo><msub><mi>ℙ</mi><msub><mi>H</mi><mn>0</mn></msub></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>B</mi><mo>≤</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mrow><annotation encoding="application/x-tex"> p_e = \mathbb{P}_{H_0} \left( B \le b \right), </annotation></semantics></math>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>
is the observed number of test statistics larger than or equal to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">s</mi></mrow></msub><annotation encoding="application/x-tex">t_\mathrm{obs}</annotation></semantics></math>
(using the observed sample of permutations that was drawn).</p>
<p>Let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mi>t</mi></msub><annotation encoding="application/x-tex">B_t</annotation></semantics></math>
be a random variable that counts the total number of possible distinct
test statistic values exceeding
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">s</mi></mrow></msub><annotation encoding="application/x-tex">t_\mathrm{obs}</annotation></semantics></math>
and recall that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>m</mi><mi>t</mi></msub><annotation encoding="application/x-tex">m_t</annotation></semantics></math>
is the total number of possible distinct permutations. We denote by
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>t</mi></msub><mo>=</mo><mfrac><mrow><msub><mi>B</mi><mi>t</mi></msub><mo>+</mo><mn>1</mn></mrow><mrow><msub><mi>m</mi><mi>t</mi></msub><mo>+</mo><mn>1</mn></mrow></mfrac><mo>,</mo></mrow><annotation encoding="application/x-tex"> p_t = \frac{B_t
+ 1}{m_t + 1}, </annotation></semantics></math>the permutation p-value
when the exhaustive list of all permutations is used.</p>
<p>As we have seen before, it is straightforward to show that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>B</mi><mi>t</mi></msub><annotation encoding="application/x-tex">B_t</annotation></semantics></math>
follows a discrete uniform distribution on the integers
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>,</mo><mi>…</mi><mo>,</mo><msub><mi>m</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">0, \dots, m_t</annotation></semantics></math>
and that, conditional on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>t</mi></msub><mo>=</mo><msub><mi>b</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">B_t = b_t</annotation></semantics></math>,
the random variable
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>
follows a binomial distribution of size
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>m</mi><annotation encoding="application/x-tex">m</annotation></semantics></math>
and rate of success
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>t</mi></msub><annotation encoding="application/x-tex">p_t</annotation></semantics></math>.
We can thus write:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>e</mi></msub><mo>=</mo><munderover><mo>∑</mo><mrow><msub><mi>b</mi><mi>t</mi></msub><mo>=</mo><mn>0</mn></mrow><msub><mi>B</mi><mi>t</mi></msub></munderover><msub><mi>ℙ</mi><msub><mi>H</mi><mn>0</mn></msub></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>B</mi><mo>≤</mo><mi>b</mi><mo stretchy="false" form="prefix">|</mo><msub><mi>B</mi><mi>t</mi></msub><mo>=</mo><msub><mi>b</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>ℙ</mi><msub><mi>H</mi><mn>0</mn></msub></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>B</mi><mi>t</mi></msub><mo>=</mo><msub><mi>b</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mn>1</mn><mrow><msub><mi>m</mi><mi>t</mi></msub><mo>+</mo><mn>1</mn></mrow></mfrac><munderover><mo>∑</mo><mrow><msub><mi>b</mi><mi>t</mi></msub><mo>=</mo><mn>0</mn></mrow><msub><mi>B</mi><mi>t</mi></msub></munderover><msub><mi>F</mi><mi>B</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>b</mi><mo>;</mo><mi>m</mi><mo>,</mo><mfrac><mrow><msub><mi>b</mi><mi>t</mi></msub><mo>+</mo><mn>1</mn></mrow><mrow><msub><mi>m</mi><mi>t</mi></msub><mo>+</mo><mn>1</mn></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mrow><annotation encoding="application/x-tex"> p_e = \sum_{b_t=0}^{B_t} \mathbb{P}_{H_0} \left( B \le b | B_t = b_t \right) \mathbb{P}_{H_0} \left( B_t = b_t \right) = \frac{1}{m_t + 1} \sum_{b_t=0}^{B_t} F_B \left( b; m, \frac{b_t + 1}{m_t + 1} \right), </annotation></semantics></math>
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mi>B</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo>;</mo><mi>m</mi><mo>,</mo><mfrac><mrow><msub><mi>b</mi><mi>t</mi></msub><mo>+</mo><mn>1</mn></mrow><mrow><msub><mi>m</mi><mi>t</mi></msub><mo>+</mo><mn>1</mn></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">F_B \left( \cdot; m, \frac{b_t + 1}{m_t + 1} \right)</annotation></semantics></math>
is the cumulative probability function of the binomial distribution of
size
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>m</mi><annotation encoding="application/x-tex">m</annotation></semantics></math>
and probability of success
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mfrac><mrow><msub><mi>b</mi><mi>t</mi></msub><mo>+</mo><mn>1</mn></mrow><mrow><msub><mi>m</mi><mi>t</mi></msub><mo>+</mo><mn>1</mn></mrow></mfrac><annotation encoding="application/x-tex">\frac{b_t + 1}{m_t + 1}</annotation></semantics></math>.</p>
<p>This can be computationally intense to compute for large values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>m</mi><mi>t</mi></msub><annotation encoding="application/x-tex">m_t</annotation></semantics></math>,
in which case one might use the following integral approximation:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>e</mi></msub><mo>≈</mo><mfrac><mrow><mi>b</mi><mo>+</mo><mn>1</mn></mrow><mrow><mi>m</mi><mo>+</mo><mn>1</mn></mrow></mfrac><mo>−</mo><msubsup><mo>∫</mo><mn>0</mn><mfrac><mn>0.5</mn><mrow><msub><mi>m</mi><mi>t</mi></msub><mo>+</mo><mn>1</mn></mrow></mfrac></msubsup><msub><mi>F</mi><mi>B</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>b</mi><mo>;</mo><mi>m</mi><mo>,</mo><msub><mi>p</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msub><mi>p</mi><mi>t</mi></msub><mi>.</mi></mrow><annotation encoding="application/x-tex"> p_e \approx \frac{b+1}{m+1} - \int_0^{\frac{0.5}{m_t+1}} F_B (b; m, p_t) dp_t. </annotation></semantics></math></p>
<p>This approximation shows that the exact p-value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>e</mi></msub><annotation encoding="application/x-tex">p_e</annotation></semantics></math>
is upper bounded by
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>u</mi></msub><mo>=</mo><mfrac><mrow><mi>b</mi><mo>+</mo><mn>1</mn></mrow><mrow><mi>m</mi><mo>+</mo><mn>1</mn></mrow></mfrac><mo>,</mo></mrow><annotation encoding="application/x-tex">
p_u = \frac{b+1}{m+1},
</annotation></semantics></math> which happens to be the exact p-value
in the case of sampling permutations without replacement.</p>
</div>
<div class="section level2">
<h2 id="comparison-by-empirical-evidence">Comparison by empirical evidence<a class="anchor" aria-label="anchor" href="#comparison-by-empirical-evidence"></a>
</h2>
<p>In <strong>flipr</strong>, you perform a permutation test using the
estimator
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><msub><mi>p</mi><mi>∞</mi></msub><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\widehat{p_\infty}</annotation></semantics></math>
of the p-value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>∞</mi></msub><annotation encoding="application/x-tex">p_\infty</annotation></semantics></math>
by setting <code>type == "estimate"</code>. This provides a non-exact
test but an unbiased estimate of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>∞</mi></msub><annotation encoding="application/x-tex">p_\infty</annotation></semantics></math>.
You perform a permutation test using the permutation p-value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>e</mi></msub><annotation encoding="application/x-tex">p_e</annotation></semantics></math>
by setting <code>type == "exact"</code>. This provides an exact test.
You also have the possibility of using the upper bound p-value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>u</mi></msub><annotation encoding="application/x-tex">p_u</annotation></semantics></math>
using <code>type == "upper_bound"</code>.</p>
<p>The following R code runs simulations to empirically estimate the
probability of wrongly rejecting the null hypothesis. The generative
model for both samples is the standard normal distribution. Sample sizes
are set to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mn>1</mn></msub><mo>=</mo><msub><mi>n</mi><mn>2</mn></msub><mo>=</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">n_1 = n_2 = 5</annotation></semantics></math>.
We draw
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>20</mn><annotation encoding="application/x-tex">20</annotation></semantics></math>
permutations for each test. We used a significance level of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mi>%</mi></mrow><annotation encoding="application/x-tex">5\%</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># General setup</span></span>
<span><span class="va">nreps</span> <span class="op">&lt;-</span> <span class="fl">1e4</span></span>
<span><span class="va">n1</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">n2</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">map</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="va">.Machine</span><span class="op">$</span><span class="va">integer.max</span>, <span class="va">nreps</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="op">~</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n1</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>      y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n2</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>      s <span class="op">=</span> <span class="va">.x</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Cluster setup</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">makeCluster</span><span class="op">(</span><span class="fu">detectCores</span><span class="op">(</span>logical <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">clusterEvalQ</span><span class="op">(</span><span class="va">cl</span>, <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://LMJL-Alea.github.io/flipr/" class="external-link">flipr</a></span><span class="op">)</span></span>
<span>  <span class="va">null_spec</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">parameters</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">map</span><span class="op">(</span><span class="va">y</span>, <span class="op">~</span> <span class="va">.x</span> <span class="op">-</span> <span class="va">parameters</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">stat_functions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">stat_t</span><span class="op">)</span></span>
<span>  <span class="va">stat_assignments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>delta <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">nperms</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span>  <span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.05</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">alpha_estimates</span> <span class="op">&lt;-</span> <span class="fu">pbapply</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pbapply/man/pbapply.html" class="external-link">pblapply</a></span><span class="op">(</span><span class="va">sim</span>, <span class="kw">function</span><span class="op">(</span><span class="va">.l</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pf</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PlausibilityFunction.html">PlausibilityFunction</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>      null_spec <span class="op">=</span> <span class="va">null_spec</span>,</span>
<span>      stat_functions <span class="op">=</span> <span class="va">stat_functions</span>,</span>
<span>      stat_assignments <span class="op">=</span> <span class="va">stat_assignments</span>,</span>
<span>      <span class="va">.l</span><span class="op">$</span><span class="va">x</span>, <span class="va">.l</span><span class="op">$</span><span class="va">y</span>,</span>
<span>      seed <span class="op">=</span> <span class="va">.l</span><span class="op">$</span><span class="va">s</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">pf</span><span class="op">$</span><span class="fu">set_nperms</span><span class="op">(</span><span class="va">nperms</span><span class="op">)</span></span>
<span>    <span class="va">pf</span><span class="op">$</span><span class="fu">set_alternative</span><span class="op">(</span><span class="st">"left_tail"</span><span class="op">)</span></span>
<span>    <span class="va">pf</span><span class="op">$</span><span class="fu">set_pvalue_formula</span><span class="op">(</span><span class="st">"exact"</span><span class="op">)</span></span>
<span>    <span class="va">pv_exact</span> <span class="op">&lt;-</span> <span class="va">pf</span><span class="op">$</span><span class="fu">get_value</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="va">pf</span><span class="op">$</span><span class="fu">set_pvalue_formula</span><span class="op">(</span><span class="st">"upper_bound"</span><span class="op">)</span></span>
<span>    <span class="va">pv_upper_bound</span> <span class="op">&lt;-</span> <span class="va">pf</span><span class="op">$</span><span class="fu">get_value</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="va">pf</span><span class="op">$</span><span class="fu">set_pvalue_formula</span><span class="op">(</span><span class="st">"estimate"</span><span class="op">)</span></span>
<span>    <span class="va">pv_estimate</span> <span class="op">&lt;-</span> <span class="va">pf</span><span class="op">$</span><span class="fu">get_value</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      exact       <span class="op">=</span> <span class="va">pv_exact</span>       <span class="op">&lt;=</span> <span class="va">alpha</span>,</span>
<span>      upper_bound <span class="op">=</span> <span class="va">pv_upper_bound</span> <span class="op">&lt;=</span> <span class="va">alpha</span>,</span>
<span>      estimate    <span class="op">=</span> <span class="va">pv_estimate</span>    <span class="op">&lt;=</span> <span class="va">alpha</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>, cl <span class="op">=</span> <span class="va">cl</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">transpose</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">simplify_all</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">map</span><span class="op">(</span><span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">as_tibble</span><span class="op">(</span><span class="va">alpha_estimates</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 3</span></span></span>
<span><span class="co">#&gt;    exact upper_bound estimate</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 0.050<span style="text-decoration: underline;">7</span>      0.050<span style="text-decoration: underline;">7</span>   0.097<span style="text-decoration: underline;">8</span></span></span></code></pre></div>
<p>This simulation provides numerical evidence that using the
permutation p-value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>e</mi></msub><annotation encoding="application/x-tex">p_e</annotation></semantics></math>
yields an exact test. This is by design since
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>e</mi></msub><annotation encoding="application/x-tex">p_e</annotation></semantics></math>
is a genuine probability hence it is uniformly distributed on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(0,1)</annotation></semantics></math>
under the null hypothesis. We also observe that the upper bound
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>u</mi></msub><annotation encoding="application/x-tex">p_u</annotation></semantics></math>
is very close to the exact p-value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>e</mi></msub><annotation encoding="application/x-tex">p_e</annotation></semantics></math>.</p>
<p>Of course, one might criticize this simulation in which the number of
permutations
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>m</mi><annotation encoding="application/x-tex">m</annotation></semantics></math>
has been chosen small on purpose to prove our point. In effect, when
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>m</mi><annotation encoding="application/x-tex">m</annotation></semantics></math>
is larger, all formulae to compute the p-value yield an asymptotically
exact test. Quoting <span class="citation">Phipson and Smyth
(2010)</span>, <em>while this is true, the urgent need to avoid small
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>m</mi><annotation encoding="application/x-tex">m</annotation></semantics></math>
disappears when the exact p-value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>e</mi></msub><annotation encoding="application/x-tex">p_e</annotation></semantics></math>
is used in place of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><msub><mi>p</mi><mi>∞</mi></msub><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\widehat{p_\infty}</annotation></semantics></math>,
because
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>e</mi></msub><annotation encoding="application/x-tex">p_e</annotation></semantics></math>
ensures a valid statistical test regardless of the sample sizes or the
number of permutations. When exact p-values are used, the only penalty
for choosing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>m</mi><annotation encoding="application/x-tex">m</annotation></semantics></math>
small is a loss of statistical power to reject the null hypothesis. This
is as it should be: more permutations should generally provide greater
power</em>.</p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-phipson2010" class="csl-entry">
Phipson, Belinda, and Gordon K Smyth. 2010. <span>“Permutation p-Values
Should Never Be Zero: Calculating Exact p-Values When Permutations Are
Randomly Drawn.”</span> <em>Statistical Applications in Genetics and
Molecular Biology</em> 9 (1). <a href="https://doi.org/10.2202/1544-6115.1585" class="external-link">https://doi.org/10.2202/1544-6115.1585</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Alessia Pini, Aymeric Stamm, Simone Vantini.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
